// OpenHacks - Event-Based Authorization Platform
// Authorization is now event-specific:
// - Any user can organize events (create Event records)
// - Event organizers assign judges per event via many-to-many relation
// - All other users are participants by default

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "sqlserver"
    url      = env("DATABASE_URL")
}

model User {
    id     String  @id // Clerk user id
    email  String  @unique
    name   String?
    bio    String?
    avatar String?

    // Common fields for all users
    website        String?
    github         String?
    linkedin       String?
    twitter        String?
    skills         String? // JSON array of skills
    university     String? // University/School
    graduationYear Int? // Graduation year

    // Relations
    memberOfTeams   Team[]         @relation("Members")
    ownedTeams      Team[]         @relation("Owner")
    registrations   Registration[] @relation("UserRegistrations")
    organizedEvents Event[]        @relation("EventOrganizer")
    judgedEvents    Event[]        @relation("EventJudges")
    scores          Score[]        @relation("JudgeScores")
    createdAt       DateTime       @default(now())
    updatedAt       DateTime       @updatedAt
}

model Event {
    id            String         @id @default(cuid())
    title         String
    description   String
    theme         String?
    tracksJson    String?
    mode          String         @default("ONLINE")
    rules         String?
    timeline      String?
    prizes        String?
    sponsors      String?
    startAt       DateTime
    endAt         DateTime
    organizerId   String
    organizer     User           @relation("EventOrganizer", fields: [organizerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    judges        User[]         @relation("EventJudges")
    teams         Team[]
    registrations Registration[]
    rounds        Round[]
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
}

model Team {
    id            String         @id @default(cuid())
    name          String
    eventId       String
    event         Event          @relation(fields: [eventId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    ownerId       String
    owner         User           @relation("Owner", fields: [ownerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    members       User[]         @relation("Members")
    registrations Registration[] @relation("TeamRegistrations")
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
}

model Registration {
    id        String   @id @default(cuid())
    eventId   String
    event     Event    @relation(fields: [eventId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    userId    String
    user      User     @relation("UserRegistrations", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    teamId    String?
    team      Team?    @relation("TeamRegistrations", fields: [teamId], references: [id], onDelete: SetNull, onUpdate: NoAction)
    createdAt DateTime @default(now())

    // Compound unique to ensure a user registers only once per event
    @@unique([eventId, userId])
}

model Round {
    id      String  @id @default(cuid())
    name    String
    index   Int
    eventId String
    event   Event   @relation(fields: [eventId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    scores  Score[]
}

model Score {
    id           String   @id @default(cuid())
    submissionId String // Mongo submission _id string
    roundId      String
    round        Round    @relation(fields: [roundId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    judgeId      String
    judge        User     @relation("JudgeScores", fields: [judgeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
    score        Int
    feedback     String?
    createdAt    DateTime @default(now())

    @@unique([submissionId, roundId, judgeId])
}
